# Введение #
Целью учебной практики было изучение способов машинной генерации
ландшафта.

Цель и требования к работе

-   Реализация алгоритма генерирования карты высот ландшафта. При
    перемещении камеры по ландшафту необходимые области должны быть
    динамически догенерированны, при этом должны учитываться уже
    сгенерированные области.

-   Для экономии вычислительных ресурсов, все области, которые находятся
    далеко от камеры должны быть сгенерированы и визуализированы в
    меньшем разрешении.

-   Визуализация полученной карты высот с возможностью
    перемещения камеры.

#  Теоретические основы #
##### Карты высот #####
Для представления ландшафта обычно используется карта высот. Карта высот
— набор значений высот для каждого значения x, z на плоскости, лежащей
горизонтально. В программировании карта высот чаще всего представляется
в виде двумерного массива переменных с плавающей точкой.

##### Динамическая генерация #####
Для возможности динамического расширения будет использоваться деление на
чанки (двумерные квадратные области) с разной детализацией. В каждый
момент времени чанки вокруг камеры (ближе определенного радиуса) должны
быть сгенерированы. Для оптимизации, разрешение (кол-во точек карты
высот) чанка будет зависеть от расстояния до камеры.

##### Детализация чанков #####
Т.к. подразумевается генерация весьма большой области (расстояние на
которое видит человеческий глаз) необходимо провести некоторые
оптимизации. Например, для чанков введем понятие уровня детализации.
Пусть размер чанка 65x65. Тогда на 0-м уровне детализации размер чанка
65x65, на 1-м 33x33, на 2-м 17x17 и т.д. Т.е. при увеличении уровня на
1, размер сетки чанка уменьшается в 2 раза.

[![chunks.png](http://s11.postimg.org/yt103r5cj/chunks.png)](http://postimg.org/image/5dvbur0sv/)

##### Алгоритмы генерации карты высот #####
Существуют множество способов создания карты высот, но почти все они
схожи в одном — использование шумов. Рассмотрим некоторые наиболее
распространенные:

-   *Diamond-square*
    Данный алгоритм дает хороший результат и позволяет догенерировать чанк
    до нужной детализации, но генерация происходит увеличением детализации.
    Т.е. сначала генерируется сетка 3x3, затем 7x7, 17x17, 33x33, …
    Из-за этого, этому алгоритму необходимо заранее иметь всю карту высот
    (генерация происходит сверху вниз). Нам необходима возможность
    достраивать карту высот динамически, поэтому этот алгоритм не подходит.

-   *Perlin Noise*
    Данный алгоритм также дает хороший результат, и не зависит от уже
    сгенерированной карты высот. Т.к. каждой точке на карте высот
    соответствует функция, данный алгоритм позволяет динамически достраивать
    карту высот и увеличивать детализацию уже сгенерированных чанков.

##### Добавление водной эрозии ##### 
Для создания эффекта водной эрозии есть несколько алгоритмов. Один из
них приведен по ссылке ниже.
[*http://www-evasion.imag.fr/Publications/2007/MDH07/FastErosion\_PG07.pdf*](http://www-evasion.imag.fr/Publications/2007/MDH07/FastErosion_PG07.pdf)
Данный алгоритм требует полностью сгенерированную карту высот для
работы, для динамического расширения карты высот и увеличения
детализации чанков он не подходит. Подходящий алгоритм найти не удалось.

#  Реализация #
##### Хранение карты высот и чанков #####
Вся карта высот хранится в ассоциативном массиве, где ключ –
целочисленная координата, значение – значение высота в данной точке. Это
позволяет

1.  Динамически расширять карту высот

2.  В отличие от двумерного массива занимает только необходимую память
    (детализация чанков может отличаться =&gt; не все координаты будут
    сразу сгенерированы)

3.  Дает доступ к точке карты высот практически за константное время.

Сами чанки – лишь абстракция. По сути чанк – квадратная область на карте
высот =&gt; может быть получен простым пересчетом координат (с учетом
детализации).

#####  Алгоритмы генерации карты высот ##### 

Были реализованы оба алгоритма (Diamond-square и Perlin Noise).
Diamond-square не подошел в явном виде, его пришлось дорабатывать. Это
ухудшило результат работы и было решено не использовать его. Реализация
Perlin Noise решала все поставленные задачи.

#####  Добавление водной эрозии ##### 

Был реализован алгоритм
<http://www-evasion.imag.fr/Publications/2007/MDH07/FastErosion_PG07.pdf>.
Были попытки доработать его для поставленной задачи, но не получилось.

##### Визуализация ##### 
Для визуализации ландшафта использовался движок Unity. Ландшафт
представлялся в виде группы стандартных Terrain объектов. Каждому чанку
соответствовал Terrain. При перемещении камеры все Terrain в области
вокруг игрока обновлялись (если Terrain не был сгенерирован раньше, то
он генерировался в низшем разрешении, если Terrain уже сгенерирован, то
при необходимости его разрешение увеличивалось)

Примеры генерации:

[![sample1.png](http://s18.postimg.org/y966vf0mh/sample1.png)](http://postimg.org/image/u01gt8xd1/)

[![sample2.png](http://s17.postimg.org/7pa5m851r/sample2.png)](http://postimg.org/image/esi11uah7/)
